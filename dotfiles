#!/usr/bin/env bash
set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

e_header() { echo -e "\n\033[1m$@\033[0m"; }
e_success() { echo -e " \033[1;32m✔\033[0m  $@"; }
e_error()   { echo -e " \033[1;31m✖\033[0m  $@"; }

to_install() {
  comm -23 <(echo "$1" | tr ' ' '\n' | sort) <(echo "$2" | tr ' ' '\n' | sort) | tr '\n' ' '
}

cd "$DOTFILES_DIR"

e_header "Running init scripts"
for script in init/*.sh; do
  [[ -f "$script" ]] && source "$script"
done

e_header "Copying files"
for file in copy/.*; do
  [[ -f "$file" ]] || continue
  name="$(basename "$file")"
  target="$HOME/$name"

  if [[ -f "$target" ]]; then
    e_success "$name (already exists)"
    continue
  fi

  cp "$file" "$target" && e_success "$name"
done

e_header "Linking files"
shopt -s dotglob
for file in link/*; do
  [[ -e "$file" ]] || continue
  name="$(basename "$file")"
  source="$DOTFILES_DIR/$file"

  if [[ "$name" == .* ]]; then
    target="$HOME/$name"
  elif [[ "$name" == "fish" ]]; then
    target="$HOME/.config/fish"
    mkdir -p "$HOME/.config"
  else
    target="$HOME/.$name"
  fi

  # Symlink exists and points to correct location - nothing to do
  if [[ -L "$target" && "$(readlink "$target")" == "$source" ]]; then
    e_success "$name (already linked)"
    continue
  # Symlink or file already exists - don't overwrite
  elif [[ -e "$target" || -L "$target" ]]; then
    e_error "Skipping $name (already exists)"
    continue
  fi

  ln -s "$source" "$target" && e_success "$name -> $target"
done
shopt -u dotglob

e_header "Done!"